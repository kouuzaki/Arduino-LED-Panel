asyncapi: '2.6.0'
info:
  title: IoT HUB08 LED Panel API
  version: '1.0.0'
  description: |
    MQTT Protocol specification for the Arduino Mega HUB08 LED Panel Controller.
    
    This device uses a **Single Command Topic** strategy. The specific operation 
    (Text, Clear, or Brightness) is determined by the `action` field in the JSON payload.
    
    NOTE: All MQTT messages published or subscribed by this device use **QoS = 1**
    (at least once delivery). Where applicable topics include MQTT bindings
    indicating the required QoS level.

servers:
  local-broker:
    url: mqtt://192.168.1.1:1884
    protocol: mqtt
    description: Local MQTT Broker

channels:
  # ----------------------------------------------------------------
  # COMMAND CHANNEL (Client -> Device)
  # ----------------------------------------------------------------
  device/{deviceId}/cmd/display:
    parameters:
      deviceId:
        description: Unique Device ID
        schema:
          type: string
          default: iot_led_panel
    publish:
      summary: Send Display Commands
      description: |
        Send commands to control the LED matrix. 
        The payload must include an `action` field to specify the command type.
        Device will respond on the `{deviceId}/response` topic.
      message:
        oneOf:
          - $ref: '#/components/messages/CommandText'
          - $ref: '#/components/messages/CommandClear'
          - $ref: '#/components/messages/CommandRestart'
      bindings:
        mqtt:
          qos: 1
          retained: false

  # ----------------------------------------------------------------
  # RESPONSE CHANNEL (Device -> Client)
  # ----------------------------------------------------------------
  response_topic:
    description: Response topic pattern is {deviceId}/response
    parameters:
      deviceId:
        description: Unique Device ID
        schema:
          type: string
          default: iot_led_panel
    subscribe:
      summary: Command Response
      description: |
        Device publishes responses to commands sent to `device/{deviceId}/cmd/display`.
        Response is published BEFORE the command is executed, giving the client
        confirmation that the command was received and will be executed.
      message:
        $ref: '#/components/messages/CommandResponse'
      bindings:
        mqtt:
          qos: 1
          retained: false

  # ----------------------------------------------------------------
  # TELEMETRY CHANNEL (Device -> Client)
  # ----------------------------------------------------------------
  system/{deviceId}/info:
    parameters:
      deviceId:
        $ref: '#/components/parameters/deviceId'
    subscribe:
      summary: System Heartbeat (Full Device Info)
      description: Published every 10 seconds (default) containing complete device information including network, services, and system status. The interval is configurable and can be set from 1 ms up to 1 day (86,400,000 ms). Published immediately upon connection.
      message:
        $ref: '#/components/messages/HeartbeatPayload'
      bindings:
        mqtt:
          qos: 1
          retained: false

components:
  parameters:
    deviceId:
      description: The unique identifier configured in the firmware.
      schema:
        type: string
        default: iot_led_panel

  messages:
    # --- Message: Text Command ---
    CommandText:
      name: textCommand
      title: Render Text
      summary: Displays multiline text with optional brightness control.
      contentType: application/json
      payload:
        type: object
        required: [action, text]
        properties:
          action:
            type: string
            const: text
            description: Discriminator value. Must be "text".
          text:
            type: string
            description: The string to display. Use '\n' for new lines.
            example: "HELLO\nWORLD"
          brightness:
            type: integer
            minimum: 0
            maximum: 255
            description: Optional. LED panel brightness (PWM 0-255). Defaults to 255 if not specified.
            example: 200
      bindings:
        mqtt:
          qos: 1
          retained: false

    # --- Message: Clear Command ---
    CommandClear:
      name: clearCommand
      title: Clear Screen
      summary: Clears the display buffer (Black screen).
      contentType: application/json
      payload:
        type: object
        required: [action]
        properties:
          action:
            type: string
            const: clear
            description: Discriminator value. Must be "clear".
      bindings:
        mqtt:
          qos: 1
          retained: false

    # --- Message: Restart Command ---
    CommandRestart:
      name: restartCommand
      title: Restart Device
      summary: Triggers a soft reset of the device via watchdog timer.
      description: |
        Device will publish a success response to {deviceId}/response topic,
        then restart in approximately 2 seconds.
      contentType: application/json
      payload:
        type: object
        required: [action]
        properties:
          action:
            type: string
            const: restart
            description: Discriminator value. Must be "restart".
      bindings:
        mqtt:
          qos: 1
          retained: false

    # --- Message: Command Response ---
    CommandResponse:
      name: commandResponse
      title: Command Response
      summary: Response from device to executed command.
      contentType: application/json
      payload:
        type: object
        properties:
          action:
            type: string
            description: The action that was executed (text, clear, restart, etc.)
            example: "text"
          status:
            type: string
            enum: [success, error, pending]
            description: Status of command execution
            example: "success"
          message:
            type: string
            description: Human-readable status message
            example: "Text displayed successfully"
          data:
            type: string
            description: Optional data related to the response
            example: "HELLO WORLD"
          timestamp:
            type: integer
            description: Milliseconds since device boot when response was generated
            example: 12345
      bindings:
        mqtt:
          qos: 1
          retained: false

    # --- Message: Heartbeat Payload ---
    HeartbeatPayload:
      name: heartbeat
      title: System Information (Full)
      contentType: application/json
      payload:
        type: object
        properties:
          message:
            type: string
            example: "Device information retrieved successfully"
          timestamp:
            type: integer
            description: Milliseconds since boot
            example: 123456789
          encrypted:
            type: boolean
            example: false
          data:
            type: array
            items:
              type: object
              properties:
                device_id:
                  type: string
                  example: "iot_led_panel"
                mac_address:
                  type: string
                  example: "02:00:00:01:02:03"
                uptime:
                  type: string
                  format: "YYYY-MM-DD HH:MM:SS"
                  example: "0000-00-00 00:15:30"
                free_memory:
                  type: string
                  example: "6 KB"
                network:
                  type: object
                  properties:
                    type:
                      type: string
                      example: "ethernet"
                    status:
                      type: string
                      enum: [connected, disconnected]
                      example: "connected"
                    connected:
                      type: boolean
                      example: true
                    ethernet_available:
                      type: boolean
                      example: true
                    ip:
                      type: string
                      format: ipv4
                      example: "192.168.1.60"
                    mac:
                      type: string
                      example: "02:00:00:01:02:03"
                    subnet_mask:
                      type: string
                      format: ipv4
                      example: "255.255.255.0"
                    gateway:
                      type: string
                      format: ipv4
                      example: "1.1.1.1"
                    dns_primary:
                      type: string
                      format: ipv4
                      example: "8.8.8.8"
                    dns_secondary:
                      type: string
                      format: ipv4
                      example: "1.1.1.1"
                mqtt_server_ip:
                  type: string
                  format: ipv4
                  example: "192.168.1.1"
                services:
                  type: object
                  properties:
                    api:
                      type: string
                      example: "running"
                    mqtt:
                      type: string
                      enum: [connected, disconnected]
                      example: "connected"
      bindings:
        mqtt:
          qos: 1
          retained: false