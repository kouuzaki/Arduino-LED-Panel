asyncapi: '2.6.0'
info:
  title: IoT HUB08 LED Panel API
  version: '1.2.0'
  description: |
    MQTT Protocol specification for the Arduino Mega HUB08 LED Panel Controller.
    
    This device uses a **Single Command Topic** strategy. The specific operation 
    (Text, Clear, or Brightness) is determined by the `action` field in the JSON payload.

servers:
  local-broker:
    url: mqtt://192.168.1.1:1884
    protocol: mqtt
    description: Local MQTT Broker

channels:
  # ----------------------------------------------------------------
  # COMMAND CHANNEL (Client -> Device)
  # ----------------------------------------------------------------
  device/{deviceId}/cmd/display:
    parameters:
      deviceId:
        description: Unique Device ID
        schema:
          type: string
          default: iot_led_panel
    publish:
      summary: Send Display Commands
      description: |
        Send commands to control the LED matrix. 
        The payload must include an `action` field to specify the command type.
      message:
        oneOf:
          - $ref: '#/components/messages/CommandText'
          - $ref: '#/components/messages/CommandClear'

  # ----------------------------------------------------------------
  # TELEMETRY CHANNEL (Device -> Client)
  # ----------------------------------------------------------------
  system/{deviceId}/info:
    parameters:
      deviceId:
        $ref: '#/components/parameters/deviceId'
    subscribe:
      summary: System Heartbeat (Full Device Info)
      description: Published every 10 seconds (configurable) containing complete device information including network, services, and system status. Published immediately upon connection.
      message:
        $ref: '#/components/messages/HeartbeatPayload'

components:
  parameters:
    deviceId:
      description: The unique identifier configured in the firmware.
      schema:
        type: string
        default: led_lilygo

  messages:
    # --- Message: Text Command ---
    CommandText:
      name: textCommand
      title: Render Text
      summary: Displays multiline text with optional brightness control.
      contentType: application/json
      payload:
        type: object
        required: [action, text]
        properties:
          action:
            type: string
            const: text
            description: Discriminator value. Must be "text".
          text:
            type: string
            description: The string to display. Use '\n' for new lines.
            example: "HELLO\nWORLD"
          brightness:
            type: integer
            minimum: 0
            maximum: 255
            description: Optional. LED panel brightness (PWM 0-255). Defaults to 255 if not specified.
            example: 200

    # --- Message: Clear Command ---
    CommandClear:
      name: clearCommand
      title: Clear Screen
      summary: Clears the display buffer (Black screen).
      contentType: application/json
      payload:
        type: object
        required: [action]
        properties:
          action:
            type: string
            const: clear
            description: Discriminator value. Must be "clear".

    # --- Message: Heartbeat Payload ---
    HeartbeatPayload:
      name: heartbeat
      title: System Information (Full)
      contentType: application/json
      payload:
        type: object
        properties:
          message:
            type: string
            example: "Device information retrieved successfully"
          timestamp:
            type: integer
            description: Milliseconds since boot
            example: 123456789
          encrypted:
            type: boolean
            example: false
          data:
            type: array
            items:
              type: object
              properties:
                device_id:
                  type: string
                  example: "iot_led_panel"
                mac_address:
                  type: string
                  example: "02:00:00:01:02:03"
                uptime:
                  type: string
                  format: "YYYY-MM-DD HH:MM:SS"
                  example: "0000-00-00 00:15:30"
                free_memory:
                  type: string
                  example: "6 KB"
                network:
                  type: object
                  properties:
                    type:
                      type: string
                      example: "ethernet"
                    status:
                      type: string
                      enum: [connected, disconnected]
                      example: "connected"
                    connected:
                      type: boolean
                      example: true
                    ethernet_available:
                      type: boolean
                      example: true
                    ip:
                      type: string
                      format: ipv4
                      example: "192.168.1.60"
                    mac:
                      type: string
                      example: "02:00:00:01:02:03"
                    subnet_mask:
                      type: string
                      format: ipv4
                      example: "255.255.255.0"
                    gateway:
                      type: string
                      format: ipv4
                      example: "1.1.1.1"
                    dns_primary:
                      type: string
                      format: ipv4
                      example: "8.8.8.8"
                    dns_secondary:
                      type: string
                      format: ipv4
                      example: "1.1.1.1"
                mqtt_server_ip:
                  type: string
                  format: ipv4
                  example: "192.168.1.1"
                services:
                  type: object
                  properties:
                    api:
                      type: string
                      example: "running"
                    mqtt:
                      type: string
                      enum: [connected, disconnected]
                      example: "connected"